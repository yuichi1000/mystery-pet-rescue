# ミステリー・ペット・レスキュー 開発マニュアル

## プロジェクト概要

### 🎮 ゲーム仕様 (Version 1.0)
- **対象年齢**: 10-14歳
- **プレイ時間**: 20-30分
- **ペット数**: 4種類（犬、猫、うさぎ、鳥）
- **マップ**: 住宅街エリアのみ
- **言語**: 日本語（英語は将来実装）

### 📊 現在の実装状況
#### ✅ 実装済み（動作確認済み）
- ゲームループ、シーン管理システム
- プレイヤー操作（8方向移動、走行）
- ペットAI（4種類、行動パターン実装）
- タイルベースマップ（64×64、7種類のタイル）
- ミニゲーム2種（アクション、記憶）
- 謎解きシステム
- UI/通知システム
- パフォーマンス最適化

#### 🚧 部分実装/要改善
- 音響システム（コードあり、音源なし）
- セーブ/ロードシステム
- インベントリシステム（未統合）

#### ❌ 未実装
- 多言語対応（英語）
- 設定画面
- NPC機能
- 一部アセット（うさぎ・鳥スプライト）

---

## 🛠️ 開発環境準備

### 📋 Amazon Q CLI プロジェクト設定

**重要**: Amazon Q CLI は `.amazonq/rules/` ディレクトリ内の Markdown ファイルを**自動的に**プロジェクトコンテキストとして読み込みます。

**手動で「README.md、DEVELOPMENT_GUIDE.md を参照のうえ」と書く必要はありません！**

`.amazonq/rules/` に以下のファイルを配置することで、すべてのプロンプトで自動的にプロジェクト情報が参照されます：

- **game-context.md**: ゲーム概要とコンセプト
- **tech-stack.md**: 技術スタック情報
- **coding-standards.md**: コーディング規約

これにより、Amazon Q CLI は常にプロジェクトの全体像を理解した状態でコード生成を行います。

### 前提条件

- Python 3.8 以上
- Pygame 2.0 以上
- Amazon Q CLI インストール済み（開発支援用）
- Git インストール済み

### クイックスタート

```bash
# リポジトリのクローン
git clone https://github.com/yuichi1000/mystery-pet-rescue.git
cd mystery-pet-rescue

# 依存関係のインストール
pip install -r requirements.txt

# ゲーム実行
python src/game_main.py
```

### プロジェクト構造の作成

```bash
q chat "Pygameを使ったゲーム「ミステリー・ペット・レスキュー」のプロジェクト構造を作成してください。

以下のディレクトリ構成を作成し、各フォルダに適切な初期ファイルも生成してください：

mystery-pet-rescue/
├── README.md                 # ゲーム企画書（簡潔版）
├── DEVELOPMENT_GUIDE.md      # 開発マニュアル（詳細版）
├── .amazonq/                 # Amazon Q CLI 設定
│   ├── rules/               # プロジェクトルール（自動適用）
│   │   ├── game-context.md  # ゲーム概要とコンセプト
│   │   ├── tech-stack.md    # 技術スタックと制約
│   │   └── coding-standards.md # コーディング規約
│   └── mcp.json            # MCP サーバー設定
├── requirements.txt          # Python依存関係
├── main.py                   # メインゲームファイル
├── config/
│   ├── __init__.py
│   ├── settings.py           # ゲーム設定
│   └── constants.py          # 定数定義
├── src/
│   ├── __init__.py
│   ├── game_engine/
│   │   ├── __init__.py
│   │   ├── game_loop.py      # メインループ
│   │   ├── scene_manager.py  # シーン管理
│   │   └── input_handler.py  # 入力処理
│   ├── entities/
│   │   ├── __init__.py
│   │   ├── player.py         # プレイヤーキャラクター
│   │   ├── pet.py           # ペットクラス
│   │   └── npc.py           # NPCクラス
│   ├── systems/
│   │   ├── __init__.py
│   │   ├── save_system.py    # セーブシステム
│   │   ├── inventory.py      # インベントリ
│   │   ├── pet_collection.py # (削除予定)
│   │   └── mini_games.py     # ミニゲーム
│   ├── ui/
│   │   ├── __init__.py
│   │   ├── menu.py          # メニューシステム
│   │   ├── hud.py           # インゲームUI
│   │   └── dialogs.py       # ダイアログ
│   └── localization/
│       ├── __init__.py
│       ├── language_manager.py
│       └── locale/
│           ├── ja_JP.json    # 日本語
│           └── en_US.json    # 英語
├── assets/
│   ├── images/
│   │   ├── characters/       # キャラクタースプライト
│   │   ├── pets/            # ペット画像
│   │   ├── ui/              # UI要素
│   │   ├── backgrounds/      # 背景画像
│   │   └── tiles/           # マップタイル
│   ├── sounds/
│   │   ├── bgm/             # 背景音楽
│   │   ├── sfx/             # 効果音
│   │   └── voice/           # 音声ガイド（将来用）
│   └── fonts/
│       ├── japanese.ttf      # 日本語フォント
│       └── english.ttf       # 英語フォント
├── data/
│   ├── maps/
│   │   ├── residential.json # 住宅街マップ
│   │   ├── park.json        # 公園マップ（将来）
│   │   └── shopping.json     # 商店街マップ（将来）
│   ├── pets/
│   │   ├── pets_v1.json     # v1.0ペットデータ
│   │   └── pets_v2.json     # 将来拡張用
│   └── quests/
│       └── tutorials.json    # チュートリアル
├── saves/
│   ├── slot1/               # セーブスロット1
│   ├── slot2/               # セーブスロット2
│   ├── slot3/               # セーブスロット3
│   └── backup/              # 自動バックアップ
├── exports/                 # エクスポート用フォルダ
├── tests/                   # テストファイル
│   ├── __init__.py
│   └── test_basic.py
├── docs/
│   ├── API.md               # コードドキュメント
│   ├── CHANGELOG.md         # 変更履歴
│   └── screenshots/         # ゲーム画面キャプチャ
└── .gitignore               # Git除外設定

特に重要なのは .amazonq/rules/ 内のファイルです：

game-context.md:
# ミステリー・ペット・レスキュー ゲームコンテキスト
- 10-14歳向けペットレスキューアドベンチャーゲーム
- 段階的リリース（v1.0は住宅街エリアのみ、20-30分プレイ）
- 多言語対応（日本語・英語）
- AI音楽生成（Beatoven.ai）、ハイブリッドセーブシステム

tech-stack.md:
# 技術スタック
- Python + Pygame
- JSON データ管理
- 多言語対応システム
- MCP + Playwright テスト自動化
- Beatoven.ai API 音楽生成

coding-standards.md:
# コーディング規約
- PEP 8 準拠
- 関数・クラス名は英語
- コメントは日本語OK
- 型ヒント必須

各ディレクトリには適切な__init__.pyファイルと、基本的な構造を持つサンプルファイルを作成してください。
.gitignoreには、saves/、exports/、__pycache__/、*.pyc、.DS_Store等を含めてください。"
```

---

## 📋 Phase 1: プロジェクト設計

#### 1.1 プロジェクト初期ファイル生成

```bash
q chat "requirements.txtファイルを作成してください。

必要なライブラリ：
- pygame (>=2.0.0)
- json (標準ライブラリ)
- pickle (標準ライブラリ)
- os (標準ライブラリ)
- datetime (標準ライブラリ)

また、main.pyの基本構造も作成してください：
- Pygameの初期化
- 画面サイズ設定（1280x720）
- 基本的なゲームループ
- FPS60設定
- ESCキーで終了
- 将来的なシーン管理への拡張を考慮した設計"
```

#### 1.2 設定ファイル作成

```bash
q chat "config/settings.pyとconfig/constants.pyを作成してください。

settings.py に含める設定：
- 画面解像度設定
- FPS設定
- 音量設定（BGM、効果音）
- 言語設定
- デバッグモード設定
- セーブスロット数

constants.py に含める定数：
- 色の定義（RGB値）
- ゲーム内の固定値（移動速度、アニメーション速度等）
- ファイルパス定数
- イベント定数

両ファイルとも将来の拡張を考慮した構造でお願いします。"
```

---

## 💻 Phase 2: 基本システム実装（✅ 実装済み）

### 2.1 メインゲームループ
- **実装ファイル**: `src/game_main.py`、`src/game_flow.py`
- **機能**: 1280×720ウィンドウ、60FPS、シーン管理、パフォーマンス最適化
- **特徴**: フレームスキップ、描画最適化、エラーハンドリング

### 2.2 プレイヤーキャラクター
- **実装ファイル**: `src/entities/player.py`
- **機能**: 
  - WASD/矢印キーで8方向移動
  - Shift押下で走行（スタミナ消費）
  - 4方向スプライト対応
  - 境界チェック機能

### 2.3 マップシステム
- **実装ファイル**: `src/systems/map_system.py`、`src/systems/map_loader.py`
- **機能**:
  - JSONマップデータ読み込み（新旧形式対応）
  - タイルサイズ64×64px（32×32から変更）
  - 7種類のタイル実装
  - 衝突判定・カメラ追従システム

---

## 🎮 Phase 3: ゲーム機能実装（✅ 実装済み）


### 3.2 インベントリシステム（🚧 部分実装）
- **実装ファイル**: `src/systems/inventory.py`、`src/systems/item_system.py`
- **状態**: コード実装済みだが、ゲーム内で未統合
- **将来実装予定**: アイテム使用、組み合わせ機能

### 3.3 ミニゲーム フレームワーク
- **実装ファイル**: `src/systems/mini_games.py`
- **実装済みゲーム**:
  1. **アクションゲーム**: 障害物回避（上下移動）
  2. **記憶ゲーム**: カード神経衰弱（4×4グリッド）
- **共通機能**: 制限時間、難易度、スコア管理

### 3.4 謎解きシステム
- **実装ファイル**: `src/systems/puzzle_system.py`
- **機能**:
  - JSON管理（`data/puzzles/puzzles_database.json`）
  - アイテム組み合わせ
  - ヒントシステム
  - 段階的進行管理

---

## 🎨 Phase 4: UI/UX 実装（✅ 実装済み）

### 4.1 メニューシステム
- **実装ファイル**: `src/scenes/menu.py`、`src/scenes/result.py`
- **実装済み画面**:
  - タイトル画面（ゲーム開始、終了）
  - 結果画面（スコア表示、リトライ）
- **未実装**: 設定画面、セーブ/ロード画面

### 4.2 インゲーム UI
- **実装ファイル**: `src/ui/game_ui.py`
- **実装済み要素**:
  - スタミナバー
  - ミニマップ
  - 現在の目標表示（救出ペット数）
  - 時間表示
  - 通知システム（複数タイプ対応）
  - デバッグ情報表示（F1-F4キー）

---

## 📦 Phase 5: コンテンツ作成（Version 1.0）

### 5.1 初期ゲームデータ生成

```bash
q chat "ゲームVersion 1.0用のペットデータ（4種類）をJSON形式で生成してください。
各ペット情報：
- 基本情報：id, name, species, rarity
- 外見：sprite_path, color_variants
- 性格：personality, favorite_food, habits
- ゲーム情報：rescue_difficulty, required_items
- 多言語対応：name_en, description_en, description_ja

住宅街エリアに登場する以下の4種類：
1. 猫（pet_cat_001）
2. 犬（pet_dog_001）
3. うさぎ（pet_rabbit_001）
4. 鳥（pet_bird_001）"
```

### 5.2 初期マップデータ作成（✅ 実装済み）
- **実装ファイル**: `data/maps/residential_v1.json`
- **マップサイズ**: 50×50タイル（3200×3200ピクセル）
- **実装済み要素**:
  - 7種類のタイル配置
  - ペット4匹の配置位置
  - 建物・環境オブジェクト配置
  - プレイヤー開始位置設定

### 5.3 多言語システム実装（❌ 未実装）
- **計画**: 日本語・英語対応
- **必要な作業**:
  - language_manager.py作成
  - locale/ja_JP.json、en_US.json作成
  - UI文字列の外部化
  - フォント対応

### 5.4 バージョン管理システム（🚧 部分実装）
- **現在**: Version 1.0固定
- **将来計画**:
  - v1.1: パズルゲーム追加
  - v1.2: 時間システム
  - v2.0: 新エリア、新ペット

---

## 🔧 Phase 6: テストと最適化（✅ 実装済み）

### 6.1 パフォーマンス最適化
- **実装内容**:
  - フレームスキップ機能
  - 描画最適化（dirty rect）
  - スプライトキャッシュシステム
  - 60FPS安定化
  - メモリ効率的な画像読み込み

### 6.2 バグ修正とテスト
- **実装済み**:
  - 境界チェック（プレイヤー、ペット）
  - エラーハンドリング強化
  - デバッグ表示（F1-F4キー）
  - クラッシュ防止機構
  - パフォーマンスレポート機能

### 6.3 ゲームバランス調整
- **調整済み項目**:
  - ペット移動速度とAI
  - ミニゲーム難易度（3段階）
  - 20-30分でクリア可能
  - 子供向けの適切な難易度

---

## 🎵 Phase 7: 音響・視覚効果（❌ 未実装）

### 7.1 音響システム
- **実装状態**: AudioSystemクラスは実装済み
- **不足要素**: すべての音源ファイル
- **必要な音源**:
  - BGM: タイトル、ゲームプレイ、勝利
  - 効果音: クリック、アイテム取得、ペット発見、救出成功
  - 推奨形式: OGG（Pygame最適）

### 7.1 Beatoven.ai API 統合による音楽生成

```bash
q chat "Beatoven.ai APIを使ったゲーム音楽生成システムを実装してください。

API統合要件：
- Beatoven.ai Python SDKの導入
- APIキー設定とセキュリティ管理
- 音楽生成リクエストの作成
- 生成された音楽ファイルのダウンロード
- Pygame音響システムとの統合

ゲーム用音楽の自動生成：
1. タイトル画面BGM: 'uplifting, magical, adventure theme for children game, 2 minutes'
2. ゲームプレイBGM: 'light, playful, exploration music for pet rescue game, 3 minutes'
4. 成功ジングル: 'happy, celebratory, short victory sound, 10 seconds'
5. ボタンクリック音: 'soft, friendly click sound for children UI, 1 second'

エラーハンドリング、API制限対応、オフライン時のフォールバック機能も含めてください。"
```

#### 音楽生成の自動化スクリプト

```bash
q chat "ゲーム開発用の音楽生成自動化スクリプトを作成してください。

機能要件：
- 設定ファイル（music_config.json）からの音楽仕様読み込み
- Beatoven.ai APIでの一括音楽生成
- 生成状況の進捗表示
- WAV/MP3/OGG形式での保存
- ファイル名の自動管理
- 生成ログの記録

音楽設定例：
{
  'title_bgm': {
    'prompt': 'magical adventure theme for children',
    'duration': 120,
    'mood': 'happy',
    'genre': 'cinematic'
  },
  'success_sfx': {
    'prompt': 'victory celebration sound',
    'duration': 5,
    'mood': 'triumphant',
    'genre': 'orchestral'
  }
}

assets/sounds/フォルダに適切に配置する機能も含めてください。"
```

### 7.2 パーティクルエフェクト（❌ 未実装）
- **計画**: ペット救助時のビジュアルフィードバック
- **必要なエフェクト**:
  - キラキラ（救助成功）
  - 光の粒（アイテム取得）
  - ハート（ペットとの友好度上昇）

---

## 💾 Phase 8: セーブシステム（✅ 実装済み）

### 8.1 セーブ/ロード機能
- **実装ファイル**: `src/systems/save_load_system.py`
- **実装済み機能**:
  - セーブスロット3つ
  - JSON形式での保存
  - 自動バックアップ
- **保存データ**: プレイヤー進行、プレイ時間
- **未実装**: 暗号化、クラウドセーブ

### 8.2 設定システム（❌ 未実装）
- **計画済み項目**:
  - 音量調整（BGM、効果音）
  - キーコンフィグ
  - フルスクリーン切り替え
  - 言語設定
- **実装ファイル**: `config/settings.py`（基本構造のみ）

---

## 🎭 E2E テスト自動化システム（MCP + Playwright）

### Phase 9: テスト自動化の革新的実装

#### 9.1 Playwright MCP サーバーのセットアップ

```bash
q chat "Playwright MCPサーバーを設定して、Amazon Q CLIと統合したいです。

セットアップ要件：
1. Playwright MCP サーバーのインストールと設定
2. Amazon Q CLI の MCP設定ファイル作成
3. ゲームアプリケーション用のテスト環境構築
4. ヘッドレスモードとGUIモードの切り替え機能

設定ファイル例：
~/.aws/amazonq/mcp.json に以下を追加：
{
  'mcpServers': {
    'playwright': {
      'command': 'npx',
      'args': ['@playwright/mcp@latest']
    }
  }
}

また、プロジェクト内での.vscode/mcp.jsonの設定も含めてください。"
```

#### 9.2 AI 駆動テストコード生成

```bash
q chat "Amazon Q CLI + Playwright MCPを使って、ペットレスキューゲームのE2Eテストを自動生成してください。

テスト要件：
1. ゲーム起動とタイトル画面の検証
2. プレイヤーキャラクターの移動テスト
3. ペット救助機能のテスト
6. 多言語切り替えテスト（日本語⇔英語）
7. 音量調整機能のテスト

自然言語でテストシナリオを記述し、Playwright MCPが実際のテストコードを生成する仕組みを実装してください。

例：
'ゲームを起動して、WASDキーでプレイヤーを移動し、最初のペットを救助してペット図鑑に登録されることを確認する'
→ 実行可能なPlaywrightテストコードに自動変換"
```

#### 9.3 自動テスト実行とレポート生成

```bash
q chat "生成されたPlaywrightテストの自動実行システムを構築してください。

実行機能：
- テストスイートの自動実行
- 並列テスト実行（マルチブラウザ対応）
- テスト結果の詳細レポート生成
- スクリーンショット付きエラーレポート
- テスト実行時間の最適化

CI/CD統合機能：
- GitHub Actionsでの自動テスト実行
- プルリクエスト時の自動テスト
- テスト結果の自動コメント投稿
- テストカバレッジレポート

継続的な改善機能：
- テスト失敗時の自動デバッグ情報収集
- パフォーマンス回帰の検出
- 新機能追加時のテスト自動生成提案"
```

---

## 📋 開発チェックリスト

### ✅ 実装済み機能
- [x] プロジェクト構造作成
- [x] 基本ゲームループ実装
- [x] プレイヤーキャラクターと移動システム
- [x] 住宅街マップシステム（タイルベース）
- [x] ミニゲーム2種類（アクション、記憶）
- [x] 謎解きシステム
- [x] メニューシステム（基本）
- [x] インゲームUI実装
- [x] ペットデータ作成（4種類）
- [x] 住宅街マップデータ完成
- [x] パフォーマンス最適化
- [x] エラーハンドリング強化

### 🚧 部分実装（要改善）
- [x] セーブ/ロード機能（実装済み）
- [ ] インベントリシステム（コードあり、未統合）

### ❌ 未実装機能
- [ ] 多言語対応（英語）
- [ ] 音響システム（BGM・効果音）
- [ ] 設定画面
- [ ] NPC機能
- [ ] パーティクルエフェクト
- [ ] 一部スプライト（うさぎ・鳥）
- [ ] E2Eテスト自動化

### 📅 今後の開発計画
- **Phase 1**: 音響実装、不足アセット作成
- **Phase 2**: 多言語対応、設定画面
- **Phase 3**: Version 1.1（新要素追加）

---

## 🚨 トラブルシューティング

### よくある問題と解決法

#### Pygame インストール問題
```bash
# エラーが出る場合
pip install --upgrade pip
pip install pygame --upgrade
```

#### ゲームが起動しない場合
- Python 3.8以上を確認
- `pygame.error: video system not initialized`の場合は、ディスプレイ設定を確認
- Windowsの場合、Visual C++ 再頒布可能パッケージが必要な場合あり

#### パフォーマンス問題
- FPSが低い場合は、デバッグ表示（F4）で確認
- スプライトサイズを小さくすることで改善可能

#### アセット読み込みエラー
- ファイルパスの大文字小文字を確認（特にLinux/Mac）
- 画像ファイルの拡張子が正しいか確認

---

## 📞 サポートリソース

- **Amazon Q CLI Discord**: フィードバックチャンネル
- **Pygame 公式ドキュメント**: https://www.pygame.org/docs/
- **GitHub Issues**: プロジェクトの問題追跡

---

## 📸 開発成果

### 現在のゲーム状態
- **プレイ可能**: メインゲームループ完成、20-30分でクリア可能
- **実装済み要素**: 4種類のペット、2種類のミニゲーム、謎解きシステム
- **技術的特徴**: 60FPS安定動作、タイルベースマップ、AI駆動のペット行動

### 今後の展開
1. **音響実装**: BGMと効果音の追加
2. **多言語対応**: 英語版の実装
3. **コンテンツ拡張**: 新エリア、新ペットの追加

### ブログ記事構成例

1. **はじめに**: ゲーム開発のきっかけ
2. **企画段階**: Claude を使った企画書作成プロセス
3. **Amazon Q CLI 活用法**: 具体的な使用例と効果
4. **技術的な挑戦**: 実装で苦労した点と解決法
5. **AI ツール比較**: Claude vs Amazon Q CLI の使い分け
6. **完成したゲーム**: 実際のゲームプレイ動画
7. **学んだこと**: AI 支援開発の感想と今後の展望

---

## 🎁 プロジェクト総括

「ミステリー・ペット・レスキュー」は、**Amazon Q と Claude**の AI ツールを活用して効率的に開発されたゲームです。

### 🚀 プロジェクトの現状

#### 実装済み（Version 1.0）
- **基本ゲーム**: 20-30分のコンパクトな体験
- **4種類のペット**: 犬、猫、うさぎ、鳥（犬・猫は完全実装）
- **2種類のミニゲーム**: アクション、記憶ゲーム
- **タイルベースマップ**: 64×64ピクセル、7種類のタイル
- **AI駆動のペット行動**: 5つの状態を持つ賢いAI

#### 技術的成果
- **パフォーマンス**: 60FPS安定動作
- **エラーハンドリング**: クラッシュ防止機構実装
- **拡張性**: 新コンテンツ追加が容易な設計

### 開発を通じて得られた知見

1. **AI活用の効果**: 基本実装は迅速に完了
2. **アセット作成の課題**: スプライトや音源の準備が最も時間がかかる
3. **段階的実装の重要性**: 完璧を求めず、動くものを先に作る

### 次のステップ

1. **音響実装**: Beatoven.aiまたはフリー音源の活用
2. **不足アセット作成**: うさぎ・鳥のスプライト
3. **多言語対応**: 英語版の実装
4. **リリース準備**: パッケージング、配布準備

**現在のコードベースは安定しており、追加開発の良い基盤となっています！** 🎮✨

---

### 🎭 MCP + Playwright テスト戦略

#### 革新的な自動化アプローチ

- **自然言語テスト記述**: 「ペットを救助して図鑑に追加されることを確認」
- **AI テストコード生成**: Amazon Q CLI が実行可能な Playwright コードを自動生成
- **エクスプローラティブテスト**: MCP が自動的にゲームを探索してバグを発見

#### 技術的メリット

- **信頼性向上**: アクセシビリティツリーベースの安定したテスト
- **開発効率**: テストコード作成時間の大幅短縮
- **継続的品質**: 新機能追加時の自動テスト生成

---

**開発頑張って！素晴らしいゲームができることを楽しみにしています！** 🎮✨
