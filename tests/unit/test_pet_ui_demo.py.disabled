#!/usr/bin/env python3
"""
ãƒšãƒƒãƒˆå›³é‘‘UIã®ãƒ†ã‚¹ãƒˆ
UIè¦ç´ ã®å‹•ä½œç¢ºèªã‚’è¡Œã†
"""

import sys
import os
import pygame
import pygame_gui
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’Pythonãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from src.ui.pet_collection_ui import PetCollectionUI
from src.systems.pet_collection import PetCollection

def test_pet_ui():
    """ãƒšãƒƒãƒˆå›³é‘‘UIã®ãƒ†ã‚¹ãƒˆ"""
    print("ğŸ® ãƒšãƒƒãƒˆå›³é‘‘UIãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("=" * 50)
    
    # Pygameã®åˆæœŸåŒ–
    pygame.init()
    screen = pygame.display.set_mode((1280, 720))
    pygame.display.set_caption("ãƒšãƒƒãƒˆå›³é‘‘UIãƒ†ã‚¹ãƒˆ")
    clock = pygame.time.Clock()
    
    # UIãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
    ui_manager = pygame_gui.UIManager((1280, 720))
    
    try:
        # ãƒšãƒƒãƒˆå›³é‘‘UIã®åˆæœŸåŒ–
        pet_ui = PetCollectionUI(screen, ui_manager)
        print("âœ… ãƒšãƒƒãƒˆå›³é‘‘UIã®åˆæœŸåŒ–: æˆåŠŸ")
        
        # UIã‚’è¡¨ç¤º
        pet_ui.show()
        print("âœ… UIè¡¨ç¤º: æˆåŠŸ")
        
        # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒšãƒƒãƒˆæ•‘åŠ©
        pet_collection = PetCollection()
        pet_collection.rescue_pet("cat_001", "è·¯åœ°è£", 180)
        pet_collection.rescue_pet("rabbit_001", "èŒ‚ã¿ã®ä¸­", 240)
        print("âœ… ãƒ†ã‚¹ãƒˆç”¨ãƒšãƒƒãƒˆæ•‘åŠ©: å®Œäº†")
        
        # çµ±è¨ˆæƒ…å ±ã®ç¢ºèª
        stats = pet_collection.get_collection_stats()
        print(f"ğŸ“Š ç¾åœ¨ã®å®Œæˆç‡: {stats['completion_rate']:.1f}%")
        
        running = True
        test_duration = 10  # 10ç§’é–“ãƒ†ã‚¹ãƒˆ
        start_time = pygame.time.get_ticks()
        
        print(f"ğŸ• {test_duration}ç§’é–“UIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...")
        print("   - ESCã‚­ãƒ¼ã§çµ‚äº†")
        print("   - ãƒã‚¦ã‚¹ã§UIæ“ä½œå¯èƒ½")
        
        while running:
            time_delta = clock.tick(60) / 1000.0
            current_time = pygame.time.get_ticks()
            
            # ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    running = False
                elif event.type == pygame.KEYDOWN:
                    if event.key == pygame.K_ESCAPE:
                        running = False
                
                # UIã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
                ui_manager.process_events(event)
                pet_ui.handle_event(event)
            
            # æ›´æ–°
            ui_manager.update(time_delta)
            pet_ui.update(time_delta)
            
            # æç”»
            screen.fill((240, 248, 255))  # èƒŒæ™¯è‰²
            ui_manager.draw_ui(screen)
            pet_ui.draw(screen)
            
            pygame.display.flip()
            
            # è‡ªå‹•çµ‚äº†ï¼ˆ10ç§’å¾Œï¼‰
            if current_time - start_time > test_duration * 1000:
                running = False
        
        print("âœ… UIãƒ†ã‚¹ãƒˆå®Œäº†")
        
    except Exception as e:
        print(f"âŒ UIãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
    
    finally:
        pygame.quit()
        print("ğŸ‰ ãƒšãƒƒãƒˆå›³é‘‘UIãƒ†ã‚¹ãƒˆçµ‚äº†")

if __name__ == "__main__":
    test_pet_ui()
